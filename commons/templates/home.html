{% extends "base.html" %}

{% block content %}
{% load static %}
        {% include "commons/includes/title.include.html" with Titulo="Bienvenidos" Subtitulo="Si estas buscando una experiencia relajante y liberadora, aqui encontraras lo que deseas " %}
        
        <div class="carousel-container">
            <div class="carousel" id="carousel">
                {% for item in carrusel_items %}
                    <div class="carousel-slide{% if forloop.first %} active{% endif %}">
                        <img src="{% static item.img_url %}" alt="{{ item.titulo }}">
                        <div class="carousel-caption">
                            <h3>{{ item.titulo }}</h3>
                            <div class="carousel-caption-row">
                                <button 
                                    class="carousel-masaje-btn"
                                    name="{{item.id}}"
                                >Ver masaje</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <button class="carousel-btn prev" onclick="moveCarousel(-1)">&#10094;</button>
                <button class="carousel-btn next" onclick="moveCarousel(1)">&#10095;</button>
            </div>
            <!-- Control de pausa fuera del bucle -->
            <div class="carousel-autoplay-control">
                <label>
                    <input type="checkbox" id="pause-autoplay">
                    <span>Pausar</span>
                </label>
            </div>
        </div>

<style>
.carousel-container {
    width: 100%;
    max-width: 40rem;
    margin: 2rem auto;
    position: relative; /* Asegura el posicionamiento absoluto del control */
}
.carousel {
    position: relative;
    overflow: hidden;
    border-radius: 1rem;
    height: 25rem; /* igual que .carousel-slide */
}
.carousel-slide {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 25rem;
    justify-content: center;
    align-items: center;
    opacity: 0;
    z-index: 0;
    transition: opacity 0.7s;
    display: flex;
    pointer-events: none;
}
.carousel-slide.active {
    opacity: 1;
    z-index: 1;
    pointer-events: auto;
}
.carousel-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 1rem;
}
.carousel-caption {
    position: absolute;
    bottom: 0rem;
    left: 0;
    width: 100%;
    text-align: center;
    color: #fff;
    background: rgba(44,62,80,0.5);
    padding: 0.5rem 0;
    border-radius: 0 0 1rem 1rem;
}
.carousel-caption h3 {
    margin: 0 0 0.5rem 0;
}
.carousel-caption button {
    background: #2f319e;
    color: #fff;
    border: none;
    padding: 0.5rem 1.2rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
}
.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(44,62,80,0.7);
    color: #fff;
    border: none;
    font-size: 2rem;
    padding: 0.3rem 0.8rem;
    cursor: pointer;
    border-radius: 50%;
    z-index: 2;
    transition: background 0.2s;
}
.carousel-btn.prev { left: 1rem; }
.carousel-btn.next { right: 1rem; }
.carousel-btn:hover { background: #2f319e; }
.carousel-autoplay-control {
    position: absolute;
    right: 1.5rem;
    bottom: 0.65rem;
    z-index: 10;
    background: rgba(44,62,80,0.7);
    color: #fff;
    padding: 0.2rem 0.7rem;
    border-radius: 0.7rem;
    font-size: 0.85rem;
    user-select: none;
    display: flex;
    align-items: center;
}
.carousel-autoplay-control input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    margin-right: 0.3rem;
}
.carousel-autoplay-control label {
    display: flex;
    align-items: center;
    margin: 0;
}
.carousel-caption-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 0.5rem;
}
</style>
<script>
let currentSlide = 0;
const slides = document.querySelectorAll('.carousel-slide');
let autoSlideInterval = null;

function showSlide(idx) {
    // Guarda el elemento enfocado antes del cambio
    const activeElement = document.activeElement;
    let focusType = null;
    if (activeElement && activeElement.classList.contains('carousel-masaje-btn')) {
        focusType = 'btn';
    } else if (activeElement && activeElement.classList.contains('carousel-autoplay-checkbox')) {
        focusType = 'checkbox';
    }

    slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === idx);

        const btn = slide.querySelector('.carousel-masaje-btn');
        const checkbox = slide.querySelector('.carousel-autoplay-checkbox');
        if (btn) btn.tabIndex = (i === idx) ? 0 : -1;
        if (checkbox) checkbox.tabIndex = (i === idx) ? 0 : -1;
    });

    // Tras cambiar, enfoca el mismo tipo de control en la nueva slide si lo había
    const activeSlide = slides[idx];
    if (focusType === 'btn') {
        const btn = activeSlide.querySelector('.carousel-masaje-btn');
        if (btn) btn.focus();
    } else if (focusType === 'checkbox') {
        const checkbox = activeSlide.querySelector('.carousel-autoplay-checkbox');
        if (checkbox) checkbox.focus();
    }
}

function moveCarousel(dir) {
    currentSlide = (currentSlide + dir + slides.length) % slides.length;
    showSlide(currentSlide);
    resetAutoSlide();
}

function autoSlide() {
    currentSlide = (currentSlide + 1) % slides.length;
    showSlide(currentSlide);
}

function resetAutoSlide() {
    clearInterval(autoSlideInterval);
    autoSlideInterval = setInterval(autoSlide, 10000); // 10 segundos
}

document.addEventListener('DOMContentLoaded', () => {
    showSlide(currentSlide);
    autoSlideInterval = setInterval(autoSlide, 10000); // 10 segundos

    // Redirección de botón
    document.querySelectorAll('.carousel-caption button').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.name;
            window.location.href = `/masajes/?tipo=${id}`;
        });
    });

    // Checkbox para pausar/reanudar autoplay
    const pauseCheckbox = document.getElementById('pause-autoplay');
    pauseCheckbox.addEventListener('change', function() {
        if (this.checked) {
            clearInterval(autoSlideInterval);
        } else {
            resetAutoSlide();
        }
    });
});
</script>
{% endblock %}